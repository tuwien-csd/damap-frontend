<!-- CONTRIBUTORS -->
<div [formGroup]="dmpForm">
  <ng-container formArrayName="contributors">
    <div *ngIf="contributors.length > 0">
      <div *ngFor="let contributor of contributors.controls; index as i">
        <mat-card appearance="raised" class="card-selected">
          <mat-card-content>
            <div class="mat-card-container">
              <div class="mat-card-left">
                <div>
                  <mat-icon class="mat-icon-style">person</mat-icon>
                  {{ contributor.value.firstName }}
                  {{ contributor.value.lastName }}
                  <mat-icon
                    *ngIf="contributor.value.contact"
                    class="mat-icon-contact button-color-primary">
                    contact_mail
                  </mat-icon>
                  <span class="sr-only">{{
                    "dmp.steps.people.contact.person" | translate
                  }}</span>
                </div>
                <mat-icon class="mat-icon-style outline">mail</mat-icon>
                {{ contributor.value.mbox }}
                <app-orcid
                  *ngIf="
                    contributor.value.personId?.identifier &&
                    contributor.value.personId?.type === identifierType.ORCID
                  "
                  [orcidId]="
                    contributor.value.personId?.identifier
                  "></app-orcid>
              </div>
              <div [formGroupName]="i">
                <mat-form-field appearance="fill">
                  <mat-label>{{
                    "dmp.steps.people.contributor.role" | translate
                  }}</mat-label>
                  <mat-select formControlName="role">
                    <mat-option
                      *ngFor="let role of roles | keyvalue"
                      [value]="role.key">
                      {{ translateEnumPrefix + role.value | translate }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
              <div class="mat-card-right">
                <button
                  mat-icon-button
                  (click)="changeContactPerson(contributor.value)"
                  *ngIf="!contributor.value.contact"
                  title="{{ 'dmp.steps.people.contact.add' | translate }}">
                  <mat-icon>contact_mail</mat-icon>
                </button>
                <button
                  mat-icon-button
                  (click)="triggerUpdateContributorDetails(i)"
                  title="{{ 'dmp.steps.people.contact.edit' | translate }}">
                  <mat-icon>edit</mat-icon>
                </button>
                <button
                  mat-icon-button
                  (click)="removeContributor(i)"
                  title="{{
                    'dmp.steps.people.contributor.remove' | translate
                  }}">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
        <div *ngIf="currentUpdateContributorIdx === i" [formGroup]="form">
          <div class="form-fields">
            <app-input-wrapper
              [label]="
                'dmp.steps.people.manual.input.question.mbox' | translate
              "
              [control]="mbox()"></app-input-wrapper>
            <app-input-wrapper
              [label]="
                'dmp.steps.people.manual.input.question.orcid' | translate
              "
              [control]="identifier()"></app-input-wrapper>
          </div>
          <div class="form-buttons">
            <button
              class="button-position button-color-primary"
              mat-raised-button
              [disabled]="form.invalid"
              (click)="updateContributorDetails(i)">
              {{ "dmp.steps.people.contact.update" | translate }}
            </button>
            <button
              class="button-position button-color-primary"
              mat-raised-button
              (click)="cancelUpdateContributorDetails()">
              {{ "dmp.steps.people.contact.cancel" | translate }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </ng-container>
</div>

<!-- SEARCH -->
<div [formGroup]="dmpForm" class="mat-search-form-field">
  <div class="search-container">
    <div class="search-and-service-container">
      <div class="app-person-search">
        <app-person-search
          [result]="
            (searchResult$ | async)?.items ?? []
              | contributorFilter: dmpForm.controls.contributors.value
          "
          (termToSearch)="searchContributor($event)"
          (personToAdd)="addContributor($event)">
        </app-person-search>
      </div>
      <div class="service-select-container">
        <mat-form-field appearance="fill">
          <mat-label>{{
            "dmp.steps.people.search.service" | translate
          }}</mat-label>
          <mat-select
            id="serviceSelect"
            [(value)]="serviceConfigType"
            (selectionChange)="onServiceConfigChange($event.value)">
            <mat-option
              *ngFor="let service of serviceConfig$ | keyvalue"
              [value]="service.value">
              {{ service.value.displayText | translate }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </div>
  </div>
</div>

<!-- LIST OF PEOPLE -->
<div class="list-container" *ngIf="projectMembers?.length > 0; else empty">
  <mat-card
    appearance="raised"
    *ngFor="
      let member of projectMembers
        | contributorFilter: dmpForm.controls.contributors.value
    ">
    <div class="mat-card-container">
      <div class="mat-card-left">
        <div>
          <mat-icon class="mat-icon-style">person</mat-icon>
          {{ member.firstName }} {{ member.lastName }}
        </div>
        <mat-icon class="mat-icon-style outline">mail</mat-icon>
        {{ member.mbox }}
      </div>
      <div class="mat-card-right">
        <button
          mat-raised-button
          *ngIf="member.universityId"
          (click)="changeContactPerson(member)"
          title="{{ 'dmp.steps.people.contact.add' | translate }}">
          <mat-icon>contact_mail</mat-icon>
        </button>
        <button
          mat-raised-button
          (click)="addContributor(member)"
          title="{{ 'dmp.steps.people.contributor.add' | translate }}">
          <mat-icon>person_add</mat-icon>
        </button>
      </div>
    </div>
    <div class="mat-card-container" *ngIf="member.roleInProject">
      <div class="projectRoleTag">
        {{ member.roleInProject }}
      </div>
      <div class="personIdentifier"></div>
    </div>
  </mat-card>
</div>
<ng-template #empty>
  {{ "dmp.steps.people.nopeople" | translate }}
</ng-template>

<!-- MANUAL INPUT -->
<app-contributor-manual
  (contactPerson)="changeContactPerson($event)"
  (contributorToAdd)="addContributor($event)">
</app-contributor-manual>
